<template>
  <div>
    <VulnerabilityTitle
      :title="title"
      :risk-rating="highestRiskRating"
      :loading="loading"
    />
  </div>
</template>

<script lang="ts">
import { Mutex } from 'async-mutex'
import VulnerabilityService from '~/scan/services/vulnerability.service'
import VulnerabilityTitle from '~/scan/components/vulnz/VulnerabilityTitle.vue'
import { type Maybe, type OxoVulnerabilityType, type RiskRatingEnum } from '~/graphql/types'

interface Data {
  vulnerabilityService: VulnerabilityService
  getVulnInfo: boolean
  mutex: Mutex
  loading: boolean
  references: { [key: string]: string }
  vulnz: Array<OxoVulnerabilityType>
  itemsPerPage: number
  currentPage: number
  countVulnerabilities: number
  highestRiskRating?: Maybe<RiskRatingEnum>
  title?: Maybe<string>
  description?: Maybe<string>
  recommendation?: Maybe<string>
}

// TODO (Rabson) Read the scanner from the object passed from the scan page.
const SCANNER = {
  name: 'dummy',
  endpoint: 'http://127.0.0.1:3420/graphql',
  apiKey: 'test'
}

export default defineComponent({
  name: 'VulnerabilityDetail',
  components: { VulnerabilityTitle },
  props: {
    scanId: {
      type: [Number, String],
      required: true
    },
    vulnTitle: {
      type: String,
      required: true
    }
  },
  data(): Data {
    return {
      loading: true,
      vulnerabilityService: new VulnerabilityService(this.$axios),
      mutex: new Mutex(),
      getVulnInfo: true,
      references: {},
      vulnz: [],
      itemsPerPage: 10,
      currentPage: 1,
      countVulnerabilities: 0,
      highestRiskRating: null,
      title: null,
      description: null,
      recommendation: null
    }
  },
  watch: {
    async vulnTitle() {
      this.getVulnInfo = true
      this.vulnz = []
      this.references = {}
      await this.fetchData()
    }
  },
  async created() {
    await this.fetchData()
  },
  methods: {
    /**
     * Fetch vulenrability data.
     */
    async fetchData(): Promise<void> {
      this.vulnerabilityService = new VulnerabilityService(this.$axios)
      await this.getDataFromApi()
    },
    /**
     * Get vulernerability data.
     */
    async getDataFromApi(): Promise<void> {
      const release = await this.mutex.acquire()
      try {
        if (this.vulnerabilityService.hasNext === true) {
          this.loading = true
          if (this.getVulnInfo === true) {
            const kbVulnerabilities = await this.vulnerabilityService.getVulnerabilitiesWithInfo({
              scanner: SCANNER,
              scanId: parseInt(this.scanId as string),
              vulnDetailTitles: [this.vulnTitle],
              kbDetailTitle: this.vulnTitle,
              page: this.currentPage,
              numberElements: this.itemsPerPage
            })
            const vulnerabilitiesData = (kbVulnerabilities || [])[0]?.vulnerabilities || { pageInfo: {}, vulnerabilities: [] }
            this.countVulnerabilities = vulnerabilitiesData?.pageInfo?.count || 0
            if ((vulnerabilitiesData?.vulnerabilities || []).length > 0) {
              const firstVulnerability = vulnerabilitiesData?.vulnerabilities[0]
              this.highestRiskRating = (kbVulnerabilities || [])[0]?.highestRiskRating
              this.title = firstVulnerability?.detail?.title
              this.description = firstVulnerability?.detail?.description
              this.recommendation = firstVulnerability?.detail?.recommendation
            }
            for (const vuln of (vulnerabilitiesData?.vulnerabilities || [])) {
              this.vulnz.push({
                id: vuln?.id,
                content: vuln?.technicalDetail
              })
            }
            this.getVulnInfo = false
          } else {
            const newVulnz = await this.vulnerabilityService.getVulnerabilitiesWithoutInfo({
              scanner: SCANNER,
              scanId: parseInt(this.scanId as string),
              detailTitles: [this.vulnTitle],
              page: this.currentPage,
              numberElements: this.itemsPerPage
            })
            for (const vuln of newVulnz) {
              this.vulnz.push({
                id: vuln?.id,
                content: vuln?.technicalDetail
              })
            }
          }
          this.currentPage = this.currentPage + 1
        }
      } finally {
        this.loading = false
        release()
      }
    },
    /**
     * Fetch more data on scroll.
     */
    async handleScroll(): Promise<void> {
      if (this.vulnerabilityService.hasNext) {
        await this.getDataFromApi()
      }
    },
    /**
     * Refresh the vulnerability data.
     */
    async reloadData(): Promise<{ vulnz: Array<OxoVulnerabilityType>, riskRating?: Maybe<RiskRatingEnum> }> {
      this.vulnerabilityService = new VulnerabilityService(this.$axios)
      this.currentPage = 1
      this.vulnz = []
      this.getVulnInfo = true
      await this.getDataFromApi()
      return { vulnz: this.vulnz, riskRating: this.highestRiskRating }
    }
  }
})
</script>
