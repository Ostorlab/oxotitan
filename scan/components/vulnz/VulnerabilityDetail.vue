<template>
  <div>
    <DfBreadcrumbs
      :scan-id="scanId"
      :vuln-title="vulnTitle"
      :breadcrumbs="breadcrumbs"
      :scanner="scanner"
      class="mb-5"
    />
    <VulnerabilityTitle
      :title="title"
      :risk-rating="highestRiskRating"
      :loading="loading"
    />
    <DfMaterialCard
      color="grey darken-1"
      light
      max-width="100%"
      class="my-12"
      icon="mdi-bug-outline"
      title="Description"
    >
      <DfEnhancedMdRender :content="description" />
    </DfMaterialCard>
    <DfMaterialCard
      color="green lighten-1"
      light
      max-width="100%"
      class="my-12"
      icon="mdi-wrench-outline"
      title="Recommendation"
    >
      <DfEnhancedMdRender :content="recommendation" />
    </DfMaterialCard>
    <DfMaterialCard
      v-if="references !== null"
      color="blue lighten-1"
      light
      max-width="100%"
      class="my-12"
      icon="mdi-link"
      title="References"
    >
      <ul>
        <li
          v-for="(url, referenceTitle) in references"
          :key="referenceTitle"
        >
          <a
            :href="url"
            target="_blank"
            scanner
          >{{ referenceTitle }}</a>
        </li>
      </ul>
    </DfMaterialCard>
    <DfMaterialCard
      color="red lighten-1"
      light
      max-width="100%"
      class="my-12"
      icon="mdi-code-braces"
      title="Technical Details"
    >
      <template #title-extra-info>
        <p class="pa-0 ma-0 mr-1 grey--text">
          Has {{ vulnerabilitiesCountText }}
        </p>
      </template>
      <template
        v-for="(item, i) of vulnz"
        :key="`issue-${item.id}-${i}`"
      >
        <div class="font-weight-bold d-flex align-center">
          <p class="mb-0">
            Issue #{{ i + 1 }}
          </p>
        </div>
        <DfEnhancedMdRender :content="item.content" />
        <v-divider
          v-if="i !== vulnz.length - 1"
          :key="i"
          class="mt-7 mb-4"
        />
      </template>
    </DfMaterialCard>
  </div>
</template>

<script lang="ts">
import { mapActions } from 'pinia'
import { Mutex } from 'async-mutex'
import { sort } from 'fast-sort'
import { useNotificationsStore } from '~/stores/notifications'
import VulnerabilityTitle from '~/scan/components/vulnz/VulnerabilityTitle.vue'
import { DfMaterialCard } from '~/dragonfly/components/Cards/DfMaterialCard'
import { DfBreadcrumbs } from '~/dragonfly/components/Sections/DfBreadcrumbs'
import { DfEnhancedMdRender } from '~/dragonfly/components/Sections/DfMdRender'
import { type Maybe, type OxoVulnerabilityType, type RiskRatingEnum } from '~/graphql/types'
import type { Scanner } from '~/project/types'
import type { VulnerabilityDetailBreadcrumbsType } from '~/dragonfly/components/Sections/DfBreadcrumbs/types'
import ScansService from '~/project/scans/services/ScanService'
import VulnerabilityService from '~/project/scans/services/vulnerability.service'

interface Data {
  vulnerabilityService: VulnerabilityService
  getVulnInfo: boolean
  mutex: Mutex
  loading: boolean
  references: { [key: string]: string }
  vulnz: Array<{ id: string, content: string }>
  itemsPerPage: number
  currentPage: number
  countVulnerabilities: number
  highestRiskRating?: Maybe<RiskRatingEnum>
  title?: Maybe<string>
  description?: Maybe<string>
  recommendation?: Maybe<string>
  currentHeight: number
  breadcrumbs: VulnerabilityDetailBreadcrumbsType
  scansService: ScansService
}

const BREADCRUMBS_SCANS_INDEX = 2

const Risks = {
  info: 1,
  important: 2,
  secure: 3,
  hardening: 4,
  potentially: 5,
  low: 6,
  medium: 7,
  high: 8,
  critical: 9
}

export default defineComponent({
  name: 'VulnerabilityDetail',
  components: { VulnerabilityTitle, DfMaterialCard, DfEnhancedMdRender, DfBreadcrumbs },
  props: {
    scanId: {
      type: [Number, String],
      required: true
    },
    vulnTitle: {
      type: String,
      required: true
    },
    scanner: {
      type: Object as () => Scanner,
      required: true
    }
  },
  data(): Data {
    return {
      scansService: new ScansService(this.$axios),
      currentHeight: 0,
      loading: true,
      vulnerabilityService: new VulnerabilityService(this.$axios),
      mutex: new Mutex(),
      getVulnInfo: true,
      references: {},
      vulnz: [],
      itemsPerPage: 10,
      currentPage: 1,
      countVulnerabilities: 0,
      highestRiskRating: null,
      title: null,
      description: null,
      recommendation: null,
      breadcrumbs: [
        {
          text: 'Scanning',
          disabled: true,
          to: '/',
          exact: true
        },
        {
          text: 'Scans',
          disabled: false,
          to: '/scan/list',
          exact: true
        },
        {
          text: 'Scan',
          disabled: false,
          exact: true,
          scans: []
        },
        {
          text: 'Vulnerability',
          scanId: this.scanId,
          exact: true,
          kbvulnerabilities: []
        }
      ]
    }
  },
  computed: {
    /**
     * The text to show (issue or issues) depending on the number of vulnerabilities.
     */
    vulnerabilitiesCountText(): string {
      if (this.countVulnerabilities === 0 || this.countVulnerabilities > 1) {
        return `${this.countVulnerabilities} issues`
      }
      return `${this.countVulnerabilities} issue`
    }
  },
  watch: {
    async vulnTitle() {
      this.getVulnInfo = true
      this.vulnz = []
      this.references = {}
      await this.fetchData()
    }
  },
  mounted() {
    addEventListener('scroll', this.handleScroll)
  },
  beforeUnmount() {
    removeEventListener('scroll', this.handleScroll)
  },
  async created() {
    await this.fetchData()
  },
  methods: {
    ...mapActions(useNotificationsStore, ['reportError']),
    /**
     * Fetch vulenrability data.
     */
    async fetchData(): Promise<void> {
      this.vulnerabilityService = new VulnerabilityService(this.$axios)
      await this.getDataFromApi()
      await Promise.allSettled([
        this.getDataFromApi(),
        this.fetchKBVulnerabilities(),
        this.fetchScans()
      ])
    },
    /**
     * Get vulernerability data.
     */
    async getDataFromApi(): Promise<void> {
      const release = await this.mutex.acquire()
      try {
        if (this.vulnerabilityService.hasNext === true) {
          this.loading = true
          if (this.getVulnInfo === true) {
            const kbVulnerabilities = await this.vulnerabilityService.getVulnerabilitiesWithInfo({
              scanner: this.scanner,
              scanId: parseInt(this.scanId as string),
              vulnDetailTitles: [this.vulnTitle],
              kbDetailTitle: this.vulnTitle,
              page: this.currentPage,
              numberElements: this.itemsPerPage
            })
            const vulnerabilitiesData = (kbVulnerabilities || [])[0]?.vulnerabilities || { pageInfo: {}, vulnerabilities: [] }
            this.countVulnerabilities = vulnerabilitiesData?.pageInfo?.count || 0
            if ((vulnerabilitiesData?.vulnerabilities || []).length > 0) {
              const firstVulnerability = vulnerabilitiesData?.vulnerabilities[0]
              this.highestRiskRating = (kbVulnerabilities || [])[0]?.highestRiskRating
              this.title = firstVulnerability?.detail?.title
              this.description = firstVulnerability?.detail?.description
              this.recommendation = firstVulnerability?.detail?.recommendation
              for (const reference of (firstVulnerability?.detail?.references || [])) {
                if (reference?.title !== undefined && reference?.title !== null) {
                  this.references[reference?.title] = reference?.url as string
                }
              }
            }
            for (const vuln of (vulnerabilitiesData?.vulnerabilities || [])) {
              this.vulnz.push({
                id: vuln?.id as string,
                content: vuln?.technicalDetail as string
              })
            }
            this.getVulnInfo = false
          } else {
            const newVulnz = await this.vulnerabilityService.getVulnerabilitiesWithoutInfo({
              scanner: this.scanner,
              scanId: parseInt(this.scanId as string),
              detailTitles: [this.vulnTitle],
              page: this.currentPage,
              numberElements: this.itemsPerPage
            })
            for (const vuln of newVulnz) {
              this.vulnz.push({
                id: vuln?.id as string,
                content: vuln?.technicalDetail as string
              })
            }
          }
          this.currentPage = this.currentPage + 1
        }
      } finally {
        this.loading = false
        release()
      }
    },
    async fetchKBVulnerabilities(): Promise<void> {
      try {
        let kbvulns = []

        const scan = await this.vulnerabilityService.getKBVulnerabilities(
          this.scanner,
          parseInt(this.scanId as string)
        )
        for (const kbVuln of (scan?.kbVulnerabilities || [])) {
          kbvulns.push({
            key: kbVuln?.kb?.title,
            goToVulnId: false,
            risk: kbVuln?.highestRiskRating,
            title: kbVuln?.kb?.title,
            description: kbVuln?.kb?.shortDescription,
            kb: kbVuln?.kb
          })
        }
        kbvulns = sort(kbvulns).by([
          {
            desc: (v) => Risks[v?.risk?.toLocaleLowerCase()]
          }
        ])
        this.breadcrumbs[3].kbvulnerabilities = kbvulns
      } catch (e: any) {
        this.reportError(e?.message || 'Error fetching scan.')
      }
    },
    /**
     * Fetch more data on scroll.
     */
    async handleScroll(): Promise<void> {
      const bottomOfWindow
          = document.documentElement.scrollTop + window.innerHeight
          > document.documentElement.offsetHeight - 300
      if (
        (bottomOfWindow
        && this.currentHeight !== document.documentElement.offsetHeight) && this.vulnerabilityService.hasNext === true
      ) {
        await this.getDataFromApi()
      }
    },
    /**
     * Refresh the vulnerability data.
     */
    async reloadData(): Promise<{ vulnz: Array<OxoVulnerabilityType>, riskRating?: Maybe<RiskRatingEnum> }> {
      this.vulnerabilityService = new VulnerabilityService(this.$axios)
      this.currentPage = 1
      this.vulnz = []
      this.getVulnInfo = true
      await this.getDataFromApi()
      return { vulnz: this.vulnz, riskRating: this.highestRiskRating }
    },
    /**
     * Fetch the most recent scans.
     */
    async fetchScans(): Promise<void> {
      this.breadcrumbs[2].scans = await this.scansService.getScans(
        this.scanner,
        {
          page: 1,
          numberElements: 20
        }
      )
      await this.updateBreadcrumbs()
    },
    /**
     * Updates the list of scans in the breadcrumbs with the current scan.
     */
    async updateBreadcrumbs(): Promise<void> {
      try {
        const currentScanInBreadcrumbs = (this.breadcrumbs[BREADCRUMBS_SCANS_INDEX]?.scans || []).find((scan) => scan.id === this.scanId)
        if (currentScanInBreadcrumbs === undefined) {
          const scan = await this.scansService.getScan(this.scanner, this.scanId)
          this.breadcrumbs[BREADCRUMBS_SCANS_INDEX].scans = [...this.breadcrumbs[BREADCRUMBS_SCANS_INDEX]?.scans || [], scan]
        }
      } catch (_e) {
        // pass
      }
    }
  }
})
</script>
