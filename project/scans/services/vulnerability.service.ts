import type { AxiosInstance } from 'axios'
import { decode } from '@shelacek/ubjson'
import RequestHandler from '~/utils/requestHandler'
import type { Scanner } from '~/project/types'
import type { OxoScanType, Maybe, OxoAggregatedKnowledgeBaseVulnerabilityType, OxoVulnerabilitiesType, OxoVulnerabilityType } from '~/graphql/types'

const GET_KB_VULNS_SCANS_QUERY = gql`query scans($scanIds: [Int]) {
    scans(scanIds: $scanIds) {
        scans {
            id
            title
            progress
            agentGroup {
              id
              name
              key
              agents {
                agents {
                  key
                  args {
                    args {
                      name
                      type
                      value
                    }
                  }
                }
              }
            }
            assets {
                __typename
                ... on OxoAndroidFileAssetType {
                  id
                  packageName
                  path
                }
                ... on OxoIOSFileAssetType {
                  id
                  bundleId
                  path
                }
                ... on OxoAndroidStoreAssetType {
                  id
                  packageName
                  applicationName
                }
                ... on OxoIOSStoreAssetType {
                  id
                  bundleId
                  applicationName
                }
                ... on OxoUrlsAssetType {
                  id
                  links {
                    url
                    method
                  }
                }
                ... on OxoNetworkAssetType {
                  id
                  networks {
                    host
                    mask
                  }
                }
                ... on OxoDomainNameAssetsType {
                  id
                  domainNames {
                    name
                  }
                }
            }
            createdTime
            kbVulnerabilities {
                highestRiskRating
                highestCvssV3Vector
                highestCvssV3BaseScore
                kb {
                    title
                    shortDescription
                    description
                    recommendation
                    references {
                        title
                        url
                    }
                }
                vulnerabilities {
                    vulnerabilities {
                        id
                        technicalDetail
                        riskRating
                        cvssV3Vector
                        detail {
                            title
                            shortDescription
                            description
                            recommendation
                            references {
                                title
                                url
                            }
                        }
                    }
                }
            }
        }
    }
}
`

const QUERY_WITH_VULN_INFO = gql`
query Vulnerabilities(
    $scanId: Int!,
    $kbDetailTitle: String,
    $vulnDetailTitles: [String!]!,
    $numberElements: Int,
    $page: Int
) {
    scan(scanId: $scanId) {
        id
        kbVulnerabilities(detailTitle: $kbDetailTitle) {
            highestRiskRating
            vulnerabilities(detailTitles: $vulnDetailTitles, numberElements: $numberElements, page: $page) {
                pageInfo {
                  count
                  numPages
                  hasNext
                  hasPrevious
                }
                vulnerabilities {
                    id
                    technicalDetail
                    riskRating
                    dna
                    detail {
                        title
                        shortDescription
                        description
                        recommendation
                        references {
                          title
                          url
                        }
                    }
                }
            }
        }
    }
}
`

const QUERY_WITH_VULN_BY_ID_INFO = gql`
query Vulnerabilities (
    $scanId: Int!,
    $vulnIds: [Int!]!,
) {
    scan(scanId: $scanId) {
        id
        vulnerabilities(vulnIds: $vulnIds) {
            vulnerabilities {
                id
                technicalDetail
                riskRating
                cvssV3Vector
                dna
                cvssV3BaseScore
                detail {
                    title
                    shortDescription
                    description
                    recommendation
                    references{
                        title
                        url
                    }
                }
            }
        }
    }
}
`

const QUERY_WITHOUT_VULN_INFO = gql`
query Vulnerabilities (
    $scanId: Int!,
    $page: Int!,
    $numberElements: Int!,
    $detailTitles: [String!]!
) {
    scan(scanId: $scanId) {
        id
        vulnerabilities(page: $page, numberElements: $numberElements, detailTitles: $detailTitles) {
            pageInfo {
              hasNext
              hasPrevious
              count
              numPages
            }
            vulnerabilities {
                id
                technicalDetail
                riskRating
                cvssV3Vector
                cvssV3BaseScore
            }
        }
    }
}
`

export default class VulnerabilityService {
  private readonly requestHandler: RequestHandler
  hasNext: boolean

  constructor(axios: AxiosInstance) {
    this.requestHandler = new RequestHandler(axios)
    this.hasNext = true
  }

  /**
     * Get KB vulnerabilities for a scan
     * @param scanner
     * @param id
     */
  async getKBVulnerabilities(scanner: Scanner, id: number): Promise<OxoScanType> {
    const res = await this.requestHandler.$axios.post(
      scanner.endpoint,
      {
        query: GET_KB_VULNS_SCANS_QUERY,
        variables: { scanIds: [id] }
      },
      {
        responseType: 'arraybuffer',
        headers: {
          'Content-Type': 'application/ubjson',
          'Accept': 'application/ubjson',
          'X-Api-Key': scanner.apiKey
        }
      }
    )
    const data = decode(res?.data)
    return (data.data?.scans?.scans || [])[0] || {}
  }

  /**
   * Get vulnerabilities with details.
   */
  async getVulnerabilitiesWithInfo({
    scanner,
      scanId,
      vulnDetailTitles,
      kbDetailTitle,
      page,
      numberElements
  }: {
    scanner: Scanner
    scanId: number
    vulnDetailTitles: Array<string>
    kbDetailTitle: string
    page: number
    numberElements: number
  }): Promise<Maybe<Array<Maybe<OxoAggregatedKnowledgeBaseVulnerabilityType>>>> {
    const res = await this.requestHandler.post(scanner, {
      query: QUERY_WITH_VULN_INFO,
      variables: {
        scanId,
        vulnDetailTitles: (vulnDetailTitles || []).filter(Boolean),
        page,
        numberElements,
        kbDetailTitle
      }
    })
    this.hasNext = res?.data?.data?.scan?.kbVulnerabilities[0]?.vulnerabilities?.pageInfo?.hasNext || false
    return res?.data?.data?.scan?.kbVulnerabilities || []
  }

  /**
     * Get a single vulnerability with details.
     */
  async getVulnerabilityByIdWithInfo({ scanner, scanId, vulnIds }: { scanner: Scanner, scanId: number, vulnIds: Array<number> }): Promise<Maybe<OxoVulnerabilitiesType>> {
    const res = await this.requestHandler.post(scanner, {
      query: QUERY_WITH_VULN_BY_ID_INFO,
      variables: {
        scanId,
        vulnIds
      }
    })
    return res?.data?.data?.scan?.vulnerabilities || { vulnerabilities: [] }
  }

  /**
     * Get vulnerabilities without details.
     */
  async getVulnerabilitiesWithoutInfo({ scanner, scanId, detailTitles, page, numberElements }: {
    scanner: Scanner
    scanId: number
    detailTitles: Array<string>
    page: number
    numberElements: number
  }): Promise<Array<Maybe<OxoVulnerabilityType>>> {
    const res = await this.requestHandler.post(scanner, {
      query: QUERY_WITHOUT_VULN_INFO,
      variables: {
        scanId,
        detailTitles,
        page,
        numberElements
      }
    })
    this.hasNext = res?.data?.data?.scan?.vulnerabilities?.pageInfo?.hasNext || false
    return res?.data?.data?.scan?.vulnerabilities?.vulnerabilities || []
  }
}
